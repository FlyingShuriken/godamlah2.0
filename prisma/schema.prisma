// Prisma schema for Better Auth
// learn more: https://better-auth.com/docs/concepts/database

generator client {
  provider      = "prisma-client-js"
  output        = "../generated/prisma"
  binaryTargets = ["native", "windows","darwin-arm64"]
}

// NOTE: When using mysql or sqlserver, uncomment the //@db.Text annotations in model Account below
// Further reading:
// https://www.prisma.io/docs/reference/api-reference/prisma-schema-reference#string

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum OrganizationType {
  COMPANY
  ORGANIZER
}

enum ProfileType {
  USER
  ORGANIZER
  COMPANY
}

enum ExperienceType {
  EVENT
  EMPLOYMENT
}

enum CheckInType {
  EVENT
  EMPLOYMENT
}

enum JobStatus {
  DRAFT
  PUBLISHED
  CLOSED
}

enum TalentVisibility {
  PRIVATE
  TALENT_POOL
}

enum VerificationStatus {
  VERIFIED
  UNVERIFIED
}

model User {
  id                   String         @id
  name                 String //@db.Text
  email                String
  emailVerified        Boolean        @default(false)
  image                String? //@db.Text
  createdAt            DateTime       @default(now())
  updatedAt            DateTime       @default(now()) @updatedAt
  // MyKad authentication - the primary identifier for Malaysian IC-based login
  mykadNumber          String?        @unique
  mykadVerifiedAt      DateTime?
  sessions             Session[]
  accounts             Account[]
  profile              UserProfile?
  profileType          ProfileType    @default(USER)
  createdOrganizations Organization[] @relation("OrganizationCreator")
  eventsCreated        Event[]        @relation("EventCreator")
  jobsCreated          JobPosting[]   @relation("JobCreator")
  experiences          Experience[]
  checkIns             CheckIn[]      @relation("UserCheckIns")
  checkInsAdded        CheckIn[]      @relation("CheckInAddedBy")
  certificates         Certificate[]

  @@unique([email])
  @@index([mykadNumber])
  @@map("user")
}

model Session {
  id        String   @id
  expiresAt DateTime
  token     String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  ipAddress String? //@db.Text
  userAgent String? //@db.Text
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([token])
  @@map("session")
}

model Account {
  id                    String    @id
  accountId             String //@db.Text
  providerId            String //@db.Text
  userId                String
  user                  User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  accessToken           String? //@db.Text
  refreshToken          String? //@db.Text
  idToken               String? //@db.Text
  accessTokenExpiresAt  DateTime?
  refreshTokenExpiresAt DateTime?
  scope                 String? //@db.Text
  password              String? //@db.Text
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  @@map("account")
}

model Verification {
  id         String   @id
  identifier String //@db.Text
  value      String //@db.Text
  expiresAt  DateTime
  createdAt  DateTime @default(now())
  updatedAt  DateTime @default(now()) @updatedAt

  @@map("verification")
}

model UserProfile {
  id                String           @id @default(cuid())
  user              User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId            String           @unique
  fullName          String?
  headline          String?
  bio               String?
  skills            String[]
  consentTalentPool Boolean          @default(false)
  visibility        TalentVisibility @default(TALENT_POOL)
  createdAt         DateTime         @default(now())
  updatedAt         DateTime         @updatedAt
}

model Organization {
  id           String           @id @default(cuid())
  name         String
  type         OrganizationType
  ssmNumber    String?
  industry     String?
  createdBy    User             @relation("OrganizationCreator", fields: [createdById], references: [id])
  createdById  String
  events       Event[]
  jobs         JobPosting[]
  experiences  Experience[]
  checkIns     CheckIn[]
  certificates Certificate[]
  createdAt    DateTime         @default(now())
  updatedAt    DateTime         @updatedAt

  @@index([name])
}

model Event {
  id             String        @id @default(cuid())
  organization   Organization  @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  organizationId String
  title          String
  description    String?
  location       String?
  startsAt       DateTime
  endsAt         DateTime?
  createdBy      User          @relation("EventCreator", fields: [createdById], references: [id])
  createdById    String
  checkIns       CheckIn[]
  experiences    Experience[]
  certificates   Certificate[]
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt

  @@index([organizationId, startsAt])
}

model JobPosting {
  id             String       @id @default(cuid())
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  organizationId String
  title          String
  description    String?
  skills         String[]
  status         JobStatus    @default(DRAFT)
  createdBy      User         @relation("JobCreator", fields: [createdById], references: [id])
  createdById    String
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  @@index([status])
}

model Experience {
  id                 String             @id @default(cuid())
  user               User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId             String
  organization       Organization?      @relation(fields: [organizationId], references: [id], onDelete: SetNull)
  organizationId     String?
  event              Event?             @relation(fields: [eventId], references: [id], onDelete: SetNull)
  eventId            String?
  type               ExperienceType
  title              String
  startDate          DateTime?
  endDate            DateTime?
  isCurrent          Boolean            @default(false)
  verificationStatus VerificationStatus @default(UNVERIFIED)
  notes              String?
  createdAt          DateTime           @default(now())
  updatedAt          DateTime           @updatedAt

  @@unique([userId, eventId, type])
  @@unique([userId, organizationId, type])
  @@index([userId, type])
}

model CheckIn {
  id                 String             @id @default(cuid())
  user               User               @relation("UserCheckIns", fields: [userId], references: [id], onDelete: Cascade)
  userId             String
  organization       Organization       @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  organizationId     String
  event              Event?             @relation(fields: [eventId], references: [id], onDelete: SetNull)
  eventId            String?
  type               CheckInType
  note               String?
  verificationStatus VerificationStatus @default(UNVERIFIED)
  addedBy            User?              @relation("CheckInAddedBy", fields: [addedById], references: [id])
  addedById          String?
  createdAt          DateTime           @default(now())

  @@unique([userId, eventId, type])
  @@unique([userId, organizationId, type])
  @@index([userId, type])
  @@index([organizationId, createdAt])
}

model Certificate {
  id             String        @id @default(cuid())
  user           User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId         String
  organization   Organization? @relation(fields: [organizationId], references: [id], onDelete: SetNull)
  organizationId String?
  event          Event?        @relation(fields: [eventId], references: [id], onDelete: SetNull)
  eventId        String?
  title          String
  issueDate      DateTime
  url            String?
  createdAt      DateTime      @default(now())

  @@index([userId])
}
